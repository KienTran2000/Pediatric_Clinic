@model PhongKhamNhi.Models.Entities.BaiViet

@{
    ViewBag.Title = Model.TieuDe;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="page-section pt-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <nav aria-label="Breadcrumb">
                    <ol class="breadcrumb bg-transparent py-0 mb-5">
                        <li class="breadcrumb-item"><a href="/News">Bài viết</a></li>
                        <li class="breadcrumb-item active" aria-current="page">@Model.TieuDe</li>
                    </ol>
                </nav>
            </div>
        </div> <!-- .row -->

        <div class="row">
            <div class="col-lg-12">
                <article class="blog-details">
                    <div class="post-thumb">
                        <img src="/Content/assets/img/blog/@Model.AnhDaiDien" alt="">
                    </div>
                    <h2 class="post-title h1">@Model.TieuDe</h2>
                    <div class="post-content">
                        @Html.Raw(Model.NoiDung)
                    </div>
                </article> <!-- .blog-details -->
                <div class="comment-form-wrap pt-5">
                    <h3 class="mb-2">Bình luận</h3>
                    @if (Session["patient"] != null)
                    {
                        <div class="form-group d-flex">
                            <input id="comment" type="text" placeholder="Nhập nội dung ..." class="form-control">
                            <input id="send" type="submit" value="Gửi" class="btn btn-primary" style="margin-left: 10px;" onclick="myFunction()">
                        </div>
                    }
                    
                <div id="list-comment">
                    @foreach (var item in ViewBag.DsBinhLuan)
                    {
                    <div id="comment-@item.MaBinhLuan" class="card p-3 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="user d-flex flex-row align-items-center">
                                <img src="~/Content/assets/img/person/user.png" width="30" class="user-img rounded-circle mr-2">
                                <span><small class="font-weight-bold text-primary">@item.BenhNhi.TenThanNhan</small></span>
                            </div>
                            <small>@item.ThoiGianTao</small>
                        </div>
                        <span style="margin-left: 35px;">@item.NoiDung</span>
                        <div class="action d-flex justify-content-between mt-2 align-items-center" style="margin-left: 10px;">
                            <div class="reply px-4">
                                @if (ViewBag.maBN == item.MaBN)
                                {
                                    <small style="color: red; cursor: pointer;" onclick="deleteComment(@item.MaBinhLuan)">Xóa</small>
                                }
                                <small style="color: cornflowerblue; cursor: pointer;" onclick="showReply(@item.MaBinhLuan)">Trả lời</small>
                            </div>
                        </div>
                        <div id="div-reply-@item.MaBinhLuan" class="form-group d-flex mt-2" style="margin-left: 33px; display: none !important;">
                            <input id="input-reply-@item.MaBinhLuan" type="text" placeholder="Nhập nội dung ..." class="form-control">
                            <input type="submit" value="Gửi" class="btn btn-primary" style="margin-left: 10px;" onclick="replyFunction(@item.MaBinhLuan)">
                        </div>
                        @foreach (var p in item.BinhLuanPhanHois)
                        {
                            <div id="reply-@p.MaPhanHoi" class="card p-3 mt-2" style="margin-left: 32px;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="user d-flex flex-row align-items-center">
                                        <img src="~/Content/assets/img/person/user.png" width="30" class="user-img rounded-circle mr-2">
                                        <span><small class="font-weight-bold text-primary">@p.BenhNhi.TenThanNhan</small></span>
                                    </div>
                                    <small>@p.ThoiGianTao</small>
                                </div>
                                <span style="margin-left: 35px;">@p.NoiDung</span>
                                <div class="action d-flex justify-content-between mt-2 align-items-center" style="margin-left: 10px;">
                                    <div class="reply px-4">
                                        @if (ViewBag.maBN == item.MaBN)
                                        {
                                            <small style="color: red; cursor: pointer" onclick="deleteReply(@p.MaPhanHoi)">Xóa</small>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    }

                </div>

                </div>
            </div>

        </div> <!-- .row -->
    </div> <!-- .container -->
</div> <!-- .page-section -->

@section scripts{
    <script>
        function myFunction () {
            let value = document.getElementById("comment").value;
            if (value.length > 0) {
                $.ajax({
                    url: "/News/NewsComment",
                    dataType: "json",
                    data: {
                        MaBaiViet: @Model.MaBaiViet,
                        NoiDung: value
                    },
                    success: function (res) {
                        if (res.status == true)
                        {
                            let de = "";
                            if (@ViewBag.maBN == res.data.MaBN)
                                de = `<small style="color: red; cursor: pointer;" onclick="deleteComment(${res.data.MaBinhLuan})">Xóa</small>`
                            $("#list-comment").prepend(`<div id="comment-${res.data.MaBinhLuan}" class="card p-3 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="user d-flex flex-row align-items-center">
                                <img src="/Content/assets/img/person/user.png" width="30" class="user-img rounded-circle mr-2">
                                <span><small class="font-weight-bold text-primary">${res.data.TenThanNhan}</small ></span >
                            </div>
                            <small>Vừa xong</small>
                        </div>
                        <span style="margin-left: 35px;">${res.data.NoiDung}</span >
                        <div class="action d-flex justify-content-between mt-2 align-items-center" style="margin-left: 10px;">
                            <div class="reply px-4">
                                ${de}
                                <small style="color: cornflowerblue; cursor: pointer;" onclick="showReply(${res.data.MaBinhLuan})">Trả lời</small>
                            </div>
                        </div>
                        <div id="div-reply-${res.data.MaBinhLuan}" class="form-group d-flex mt-2" style="margin-left: 33px; display: none !important;">
                            <input id="input-reply-${res.data.MaBinhLuan}" type="text" placeholder="Nhập nội dung ..." class="form-control">
                            <input type="submit" value="Gửi" class="btn btn-primary" style="margin-left: 10px;" onclick="replyFunction(${res.data.MaBinhLuan})">
                        </div>
                    </div>
`);
                        }
                        else
                            MessageBox("Có lỗi trong quá trình xử lý. Vui lòng thử lại.", "error");
                    }
                });
            }
            else
                MessageBox("Bạn chưa nhập nội dung bình luận", "warning");
        };

        function replyFunction(maBinhLuan) {
            //console.log('esssssss', $(e).parents().parents());
            let value = document.getElementById(`input-reply-${maBinhLuan}`).value;
            if (value.length > 0) {
                $.ajax({
                    url: "/News/ReplyComment",
                    dataType: "json",
                    data: {
                        MaBinhLuan: maBinhLuan,
                        NoiDung: value
                    },
                    success: function (res) {
                        if (res.status == true)
                        {
                            let de = "";
                            if (@ViewBag.maBN == res.data.MaBN)
                                de = `<small style="color: red; cursor: pointer;" onclick="deleteReply(${res.data.MaPhanHoi})">Xóa</small>`
                            $(`#comment-${maBinhLuan}`).append(`<div id="reply-${res.data.MaPhanHoi}" class="card p-3 mt-2" style="margin-left: 32px;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="user d-flex flex-row align-items-center">
                                        <img src="/Content/assets/img/person/user.png" width="30" class="user-img rounded-circle mr-2">
                                        <span><small class="font-weight-bold text-primary">${res.data.TenThanNhan}</small></span>
                                    </div>
                                    <small>Vừa xong</small>
                                </div>
                                <span style="margin-left: 35px;">${res.data.NoiDung}</span>
                                <div class="action d-flex justify-content-between mt-2 align-items-center" style="margin-left: 10px;">
                                    <div class="reply px-4">
                                        ${de}
                                    </div>
                                </div>
                            </div>`);
                            document.getElementById(`input-reply-${maBinhLuan}`).value = "";
                        }
                        else
                            MessageBox("Có lỗi trong quá trình xử lý. Vui lòng thử lại.", "error");
                    }
                });
            }
            else
                MessageBox("Bạn chưa nhập nội dung phản hồi", "warning");
        }

        function showReply(maBinhLuan) {
            if (@ViewBag.maBN > 0)
                $(`#div-reply-${maBinhLuan}`).show();
            else
                MessageBox("Bạn cần đăng nhập để bình luận", "error");
        }

        function deleteComment(maBinhLuan) {
            $.ajax({
                url: `/News/DeleteComment/${maBinhLuan}`,
                    dataType: "json",
                    success: function (res) {
                        if (res.status == true)
                        {
                            $(`#comment-${maBinhLuan}`).remove();
                        }
                        else
                            MessageBox("Có lỗi trong quá trình xử lý. Vui lòng thử lại.", "error");
                    }
                });
        }

        function deleteReply(maPhanHoi) {
            $.ajax({
                url: `/News/DeleteReply/${maPhanHoi}`,
                dataType: "json",
                success: function (res) {
                    if (res.status == true) {
                        $(`#reply-${maPhanHoi}`).remove();
                    }
                    else
                        MessageBox("Có lỗi trong quá trình xử lý. Vui lòng thử lại.", "error");
                }
            });
        }

    </script>
}